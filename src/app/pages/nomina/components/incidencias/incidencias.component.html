<div class="mx-auto p-4">

  <p-toast></p-toast>

  <!-- Selector de rango de fechas -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-6 rounded-2xl 
              bg-gradient-to-r from-primary/20 to-primary/10 shadow-md border border-primary/30 mb-4">
    <div class="flex items-center gap-4">
      <div class="bg-white dark:bg-gray-800 rounded-full p-4 shadow-lg flex items-center justify-center -mt-4">
        <i class="pi pi-calendar text-3xl text-primary"></i>
      </div>
      <div class="flex flex-col">
        <h2 class="text-3xl font-extrabold text-primary dark:text-primary-300 tracking-tight">
          Incidencias
        </h2>
        <span class="text-sm text-gray-600 dark:text-gray-400">Resumen de incidencias por usuario</span>
      </div>
    </div>

    <p-datepicker
      [(ngModel)]="rangoFechas"
      selectionMode="range"
      dateFormat="yy-mm-dd"
      (onSelect)="onRangoFechasChange($event)"
      [showIcon]="true"
      placeholder="Selecciona un rango de fechas"
      class="w-full sm:w-64"
    ></p-datepicker>
  </div>

  <!-- Tabla de usuarios con incidencias -->
  <p-table [value]="getUsuariosAgrupados()" [paginator]="true" [rows]="10" #dt
           [responsiveLayout]="'scroll'" class="shadow-md rounded-2xl overflow-hidden">

    <!-- Encabezado -->
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="usuario">
          Usuario
          <p-columnFilter type="text" field="usuario" display="menu"></p-columnFilter>
        </th>
        <th>Días con incidencias</th>
        <th *ngFor="let codigo of Object.keys(codigosIncidencias)">
          {{ codigo }}
        </th>
      </tr>
    </ng-template>

    <!-- Cuerpo -->
    <ng-template pTemplate="body" let-usuarioResumen>
      <tr>
        <td>{{ usuarioResumen.usuario }}</td>
        <td>{{ usuarioResumen.diasConIncidencias }}</td>

        <td *ngFor="let codigo of Object.keys(codigosIncidencias)">
          <ng-container *ngIf="usuarioResumen.incidencias[codigo]">
            <span 
              [pTooltip]="usuarioResumen.incidencias[codigo].cubierta ? 
                         'Cubierta por permiso' : usuarioResumen.incidencias[codigo].descripcion"
              tooltipPosition="top"
              [ngClass]="{
                'badge badge-success': usuarioResumen.incidencias[codigo].cubierta,
                'badge badge-danger': !usuarioResumen.incidencias[codigo].cubierta
              }">
              {{ usuarioResumen.incidencias[codigo].count }}
            </span>
          </ng-container>
        </td>
      </tr>
    </ng-template>

    <!-- Mensaje vacío -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="200"
         class="text-center">
          No hay registros para este rango de fechas
        </td>
      </tr>
    </ng-template>

  </p-table>
</div>
